# Closing the loop: Teaching single-cell foundation models to learn from perturbations

## Abstract 
The application of transfer learning models to large scale single-cell datasets has enabled the development of single-cell foundation models (scFMs) that can predict cellular responses to perturbations in silico. Although these predictions can be experimentally tested, current scFMs are unable to “close the loop” and learn from these experiments to create better predictions. Here, we introduce a “closed-loop” framework that extends the scFM by incorporating perturbation data during model fine-tuning. Our closed-loop model improves prediction accuracy, increasing positive predictive value in the setting of T-cell activation three-fold. We applied this model to RUNX1-familial platelet disorder, a rare pediatric blood disorder and identified two therapeutic targets (mTOR and CD74-MIF signaling axis) and two novel pathways (protein kinase C and phosphoinositide 3-kinase). This work establishes that iterative incorporation of experimental data to foundation models enhances biological predictions, representing a crucial step toward realizing the promise of "virtual cell" models for biomedical discovery.

## T-cell activation experiments
We used publicly available single-cell RNA sequencing data from 4 studies where T cells were either unstimulated or stimulated via CD3-CD28 beads or phorbol myristate acetate/ionomycin (PMA/ionomycin): 
1.	[Kartha et al](https://www.sciencedirect.com/science/article/pii/S2666979X22001082) performed scRNAseq on resting and stimulated primary human peripheral blood mononuclear cells (PBMCs) from 4 donors. We included the scRNAseq data from 3,708 T cells which were unstimulated and 3,797 T cells which were stimulated with PMA/ionomycin along with Brefeldin A, a protein secretion inhibitor which allows us to isolate the primary effect of T cell activation. They were stimulated with PMA and Ionomycin calcium salt with or without Brefeldin A.
2.	[Cano-Gomez et al](https://www.nature.com/articles/s41467-020-15543-y) performed scRNAseq on primary T cells with and without anti-CD3/anti-CD28 beads in the absence of cytokines (Th0). CD4+ T cells were isolated from the PBMCs of 6 donors. T cells were then stimulated with anti-CD3/anti-CD28 human T-activator dynabeads. They profiled gene expression (RNA-seq) at 16 hours. A total of 5,269 resting T cells were profiled and 7,309 stimulated T cells were profiled.
3.	[Lawlor et al](https://www.frontiersin.org/journals/immunology/articles/10.3389/fimmu.2021.636720/full) performed scRNAseq on PBMCs from 10 donors. PBMCs were cultured in control media (resting) versus plate-bound anti-CD3 + anti-CD28 (stimulated). 4,589 T cells were stimulated and 3,694 T cells were resting.
4.	[Szabo et al](https://www.nature.com/articles/s41467-019-12464-3) performed scRNAseq T cells, after CD3+ selection, from the blood of two deceased adult organ donors and two healthy adult volunteers with and without T-cell receptor stimulation using anti-CD3/CD28 T-activator for 16 hours. There were 9,147 resting T cells and 8,478 activated T cells.

For analysis with Geneformer, the single-cell RNAseq data was combined into a Seurat object and converted to a Loom object for tokenization. For DE analysis, Harmony was used to integrate the data from the four studies. Cells were grouped based on similarity of cell states using the Python package Metacell-2 with a targeted metacell size of 160,000 transcripts. Differential expression testing was performed using the Wald test for negative binomial regression through DESeq2 for genes that had at least 10 transcripts in at least 85% of metacells.

## T-cell in silico perturbation
For predicting T-cell activation status, we fine-tuned the pretrained Geneformer-30M-12L model using publicly available scRNA-seq data from four independent studies where T cells were stimulated via CD3-CD28 beads or PMA/ionomycin, comprising a total of 37,991 cells (20,707 activated, 17,284 resting). The fine-tuning process was implemented using a custom classifier framework with a learning rate of 5x10-5, batch size of 6, gradient accumulation steps of 2, and linear learning rate scheduling with warm-up over 10 epochs. All 12 transformer layers were kept unfrozen during training to allow complete model adaptation to the T-cell activation task. After fine-tuning, we performed in silico perturbation (ISP) using the InSilicoPerturber class to systematically analyze the effect of genetic perturbations on T-cell activation state. For each gene in the GeneCorpus, we simulated both overexpression (by moving the gene to the front of the rank value encoding) and knockout (by removing the gene from the encoding). Cell embeddings were extracted from the final layer (layer 12) of the model, as these contain the most task-specific representations relevant to T-cell activation. We quantified the effects of these perturbations by measuring the cosine similarity between the original and perturbed cell embeddings, allowing precise determination of how each perturbation shifted cells toward either activated or resting states. The InSilicoPerturberStats class was used to process and analyze the large-scale perturbation data, calculating effect sizes and statistical significance for each gene perturbation. 

The script to perform in silico perturbation is [here](https://github.com/bicklab/geneformer/blob/main/scripts/geneformer_isp_finetunedclassifier_buenrostro_05312024.py). 

## Evaluation of ISP for T cell activation with flow cytometry 
We validated our predictions against orthogonal flow cytometry data by [Schmidt, Science, 2022](https://www.science.org/doi/10.1126/science.abj4008) to evaluate our predictions from CRISPR activation and interference screens that measured IL-2 and IFN-γ production after CD3-CD28 stimulation in over 18,000 genes. This allowed systematic evaluation of ISP predictions compared to differential expression (DE) analysis using ground truth experimental data as a benchmark. To determine the minimum number of perturbation examples required for significant improvement, we systematically evaluated model performance with incremental additions of random perturbation subsets. Performance metrics including positive predictive value, negative predictive value, sensitivity, and specificity were calculated using flow cytometry data as ground truth to quantify the improvements gained through the closed-loop approach.

## Fine-tuning with T cell Perturbseq data
To enhance prediction accuracy, we developed a "closed-loop" ISP framework incorporating experimental perturbation data during model fine-tuning. We integrated both unperturbed T-cell transcriptomes and Perturbseq data from CRISPR activation and interference screens in primary human T cells. Critically, the Perturbseq data was labeled only with activation status rather than specific gene perturbation information, enabling the model to learn cellular responses to genetic perturbations while remaining agnostic to the specific targets. This fine-tuning approach used the BertForSequenceClassification architecture with DataCollatorForCellClassification to handle batching and preprocessing of transcriptomic data. The model was fine-tuned to distinguish between activated and resting T-cell states using gradient-based optimization with early stopping based on validation performance. We systematically evaluated the minimum number of perturbation examples required for significant improvement by incrementally adding random subsets of perturbation data to the fine-tuning dataset, measuring performance metrics at each increment. Following fine-tuning with the closed-loop approach, we performed ISP on all genes except those 75 genes included in the Perturbseq training data to avoid data leakage. The EmbExtractor class was used to extract and analyze cell-state embeddings, enabling precise quantification of cellular state shifts in response to in silico perturbations. 

The script to perform in silico perturbation is [here](https://github.com/bicklab/geneformer/blob/main/scripts/geneformer_build_classifier_yp_012724.py). 

```
cd /Users/pershy1/geneformer
git add .
git commit -m "Updating geneformer scripts" (replace with more descriptive if desired)
git push origin main
```

Voila! Now, polaris should match local which should match GitHub.
